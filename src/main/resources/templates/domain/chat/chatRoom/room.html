<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>채팅방 목록</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>

<body class="template--body">


<!-- ----------------------------------------------- -->


<!-- Template-header 시작 -->
<th:block th:replace="~{domain/layout/header}"></th:block>
<!-- Template-header 끝 -->


<!-- ----------------------------------------------- -->


<!-- Template-main 시작 -->
<main class="content">
    <!-- 왼쪽 네비게이션 메뉴 -->
    <!-- 왼쪽 메뉴바 포함 -->
    <div th:replace="~{domain/layout/mypage-leftAside}"></div>

    <section class="main-content">
        <h1 th:text="|${roomId}번 채팅방|"></h1>

        <nav>
            <a href="list">채팅방 목록</a>
        </nav>

        <form onsubmit="submitWriteForm(this); return false;" method="POST">
            <input autocomplete="off" type="text" name="content" placeholder="내용">
            <input type="submit" value="작성">
        </form>

        <div>
            <ul class="chat__messages">
                <li th:each="chatMessage : ${room.chatMessages}">
                    <th:block th:text="${chatMessage.writerName}"></th:block>
                    :
                    (
                    <th:block th:text="${chatMessage.id}"></th:block>
                    )
                    <th:block th:text="${chatMessage.content}"></th:block>
                </li>
            </ul>
        </div>

    </section>

</main>
<!-- Template-main 끝 -->

<!-- ----------------------------------------------- -->


<!-- Template-footer 시작 -->
<th:block th:replace="~{domain/layout/footer}"></th:block>
<!-- Template-footer 끝 -->


<!-- ----------------------------------------------- -->


<script th:inline="javascript">
    const roomId = /*[[${roomId}]]*/ 0;
    let lastChatMessageId = /*[[${room.chatMessages.size > 0 ? room.chatMessages.get(0).id : 0}]]*/ 0;
</script>

<script>
    const chatMessagesEl = document.querySelector('.chat__messages');

    function submitWriteForm(form) {

        form.content.value = form.content.value.trim();

        if (form.content.value.length == 0) {
            alert('내용을 입력해주세요.');
            form.content.focus();
            return;
        }

        const action = `/chat/room/${roomId}/write`;

        fetch(
            action,
            {
                method: 'POST',
                headers: {
                    'accept': 'application/json',
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    content: form.content.value,
                }),
            }
        )
            .catch(error => alert(error));

        form.content.value = '';
        form.content.focus();
    }

    function drawMoreChatMessage(message) {
        lastChatMessageId = message.id;

        chatMessagesEl
            .insertAdjacentHTML(
                "afterBegin",
                `<li>${message.writerName} : ( ${message.id} ) ${message.content}</li>`
            );
    }

    const socket = new SockJS('/ws');
    const stompClient = Stomp.over(socket);

    stompClient.connect({}, function (frame) {
        console.log('Connected: ' + frame);

        stompClient.subscribe(`/topic/chat/room/${roomId}/message`, function (data) {
            const jsonData = JSON.parse(data.body);
            drawMoreChatMessage(jsonData.message);
        });
    });

</script>

</body>


<!-- bootstrap -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
        crossorigin="anonymous"></script>

</html>
