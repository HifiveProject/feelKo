<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>채팅방 목록</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>

<h1>채팅방 목록</h1>

<ul class="chat__messages">
    <li th:each="chatRoomListDto : ${chatRooms}" th:data-chat-room-id="${chatRoomListDto.getChatRoomId()}">
        <a th:href="@{/chat/room/{chatRoomId}(chatRoomId=${chatRoomListDto.getChatRoomId()})}">
            <!--   TODO   ui 작업 후에는 id를 숨겨야함 지금은 헷갈려서 그냥둠        -->
            <span th:text="|${chatRoomListDto.getChatRoomId()}.|">채팅방 id</span>
            <span th:text="${chatRoomListDto.getName()}">채팅방 이름</span>
            <span th:text="${chatRoomListDto.getLastMessage()}">마지막 메세지</span>
        </a>
    </li>
</ul>
</body>
</html>

<script th:inline="javascript">
    const memberId = /*[[${#authentication.principal.id}]]*/ 0;

    const chatMessagesEl = document.querySelector('.chat__messages');

    function drawMoreChatMessage(message) {
        // 기존의 채팅방 메시지가 있는지 확인하고, 있다면 해당 요소를 삭제합니다.
        const existingChatRoomElement = chatMessagesEl.querySelector(`li[data-chat-room-id="${message.chatRoom.id}"]`);
        if (existingChatRoomElement) {
            existingChatRoomElement.remove();
        }

        // 새 채팅방 메시지를 삽입합니다. 링크 추가 포함
        const chatRoomItemHtml = `
        <li data-chat-room-id="${message.chatRoom.id}">
            <a href="/chat/room/${message.chatRoom.id}">
                      <!--      TODO ui 작업 후에는 id를 숨겨야함          -->
        <span>${message.chatRoom.id}. </span>
        <span>${message.chatRoomName} </span>
        <span>${message.content}</span>
        </a>
        </li>
        `;

        chatMessagesEl.insertAdjacentHTML("afterBegin", chatRoomItemHtml);

    }

    const socket = new SockJS('/ws');
    const stompClient = Stomp.over(socket);

    stompClient.connect({}, function (frame) {
        console.log('Connected: ' + frame);

        stompClient.subscribe(`/topic/chat/room/list/` + memberId + `/messageCreated`, function (data) {
            const jsonData = JSON.parse(data.body);
            drawMoreChatMessage(jsonData.message);
        });
    });

</script>